
name: Deploy to GitHub Pages
on:
  push:
    branches: ["main"]
permissions:
  contents: read
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install & Build
        run: |
          npm install
          npm run build
      - name: Inject API Key
        env:
          GEMINI_SECRET: ${{ secrets.API_KEY }}
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const secret = process.env.GEMINI_SECRET;
            
            if (!secret || secret.length < 10) {
              console.error('CRITICAL ERROR: Secret API_KEY is missing or empty in GitHub Secrets!');
              process.exit(1); 
            }
            
            const distPath = 'dist';
            const files = [];
            
            function getFiles(dir) {
              if (!fs.existsSync(dir)) return;
              fs.readdirSync(dir).forEach(file => {
                const fullPath = path.join(dir, file);
                if (fs.statSync(fullPath).isDirectory()) {
                  getFiles(fullPath);
                } else if (file.endsWith('.js') || file.endsWith('.html') || file.endsWith('.txt')) {
                  files.push(fullPath);
                }
              });
            }
            
            getFiles(distPath);
            console.log('Targeting ' + files.length + ' files for key injection...');
            
            let injectionCount = 0;
            files.forEach(f => {
              let content = fs.readFileSync(f, 'utf8');
              if (content.includes('__API_KEY_PLACEHOLDER__')) {
                const newContent = content.split('__API_KEY_PLACEHOLDER__').join(secret);
                fs.writeFileSync(f, newContent);
                console.log('  Successfully injected into: ' + f);
                injectionCount++;
              }
            });
            
            if (injectionCount === 0) {
              console.warn('WARNING: No placeholder tags were found in the build folder. Key may not have been injected.');
            } else {
              console.log('Injection complete. Total files modified: ' + injectionCount);
            }
          "
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
